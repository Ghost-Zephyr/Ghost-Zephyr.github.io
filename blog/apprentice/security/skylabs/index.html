<!doctype html><html lang=en><head><meta charset=utf-8><meta name=robots content="index,follow"><title>Sivert Does Stuff Online! - SkyLabs</title><meta name=description content="Security issues I found working as an apprentice at SkyLabs AS. Compared to Sircon, these ones I actually had to figure out how to fix myself."><link rel=icon href=/favicon.2a782c1d4fdbd387db5d712ee87bd8b01eb0cf56bd95198f4cc6a84ccf8bfb7e.png integrity='sha256-KngsHU/b04fbXXEu6HvYsB6wz1a9lRmPTMaoTM+L+34='><link rel=apple-touch-icon href=/favicon_hu5ee1517d9ee6726a25cfeec6a86e1947_41990_192x192_resize_box_3.3306e29c64ba856a2bd380475dcf6fcf81e835e05927358f6e225bbbdf44032a.png integrity='sha256-MwbinGS6hWor04BHXc9vz4HoNeBZJzWPbiJbu99EAyo='><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#00FF00"><meta name=twitter:card content="summary"><meta property="og:title" content="Sivert Does Stuff Online!"><meta property="og:url" content="https://io.sivert.pw"><meta property="og:site_name" content="Sivert Does Stuff Online!"><meta name=generator content="Hugo 0.101.0"><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css crossorigin=anonymous><link href='/chroma.min.b7cbccb1554b70a7ffff2ffa00c8ce8e6cc8506a98c47088b8ec08515e93d4b9.css' integrity="sha256-t8vMsVVLcKf//y/6AMjOjmzIUGqYxHCIuOwIUV6T1Lk=" rel=stylesheet><link href='/main.min.40279eb0f110198656154e7ae4a29d8fe0624fd7f7ea418b1c0ad29792c75207.css' integrity="sha256-QCeesPEQGYZWFU565KKdj+BiT9f36kGLHArSl5LHUgc=" rel=stylesheet></head><body><header><nav id=navbar><ul class=top-nav><li><a href=/>Sivert Does Stuff Online!</a></li><li><a href=/blog/apprentice><span>Apprentice docs</span></a></li><li id=right><ul><li><a href=https://sivert.pw><span>My Humble Homepage</span></a></li><li><a href=/old><span>Old GitHub.io</span></a></li><li><a href=/about><span>About</span></a></li><li><a href=/blog><span>Blog</span></a></li></ul></li></ul></nav></header><div id=content><main><div class=row><div class=col-md-2><aside id=meta><header><h4>SkyLabs</h4><p>This article has 691 words.
4 minutes to read.</p></header><h6>Table of Contents:</h6><nav id=TableOfContents><ul><li><a href=#sky-id-admin>Sky ID Admin</a><ul><li><a href=#funny>Funny</a></li><li><a href=#minor>Minor</a></li></ul></li></ul></nav></aside></div><div class=col-md-10><article><header><h1>SkyLabs</h1></header><p>SkyLabs has surprisingly good stability compared to expectations based on the codebase.
I&rsquo;m guessing it&rsquo;s a byproduct of Python that let&rsquo;s us fail pretty safely on almost all endpoints.
The in-house development is mainly four services, two JS frontends and two Python Flask backends, all web.</p><p>These services are a captive portal, it&rsquo;s API and an admin interface web app and it&rsquo;s API.</p><p>We support lots of interesting <a href=https://wiki.skylabs.no/partner:authentication target=_blank>authentication</a> methods!~</p><h2 id=sky-id-admin>Sky ID Admin</h2><p>And so far the only real security related issue I&rsquo;ve found in the in-house codebase is that the Access Control was missing a check.
The problem is that API keys that are associated with a deleted account is valid.
Allowed methods are by x-api-key Authorization header, api-key as an url parameter or by Json Web Token.
The JWT is passed in an Authorization Bearer header, which is wrong, <a href=https://datatracker.ietf.org/doc/html/rfc6750 target=_blank>Bearer</a> Auth header prefix should be reserved for <a href=https://datatracker.ietf.org/doc/html/rfc6749 target=_blank>OAuth 2</a>.</p><p>Anyway when using API keys, not JWT, the server just fetches the API key record from the database.
The function calls for this goes from the Access Control controller class through an API key controller.
Problem is the API key controller class only checks if the associated user exists, not if it&rsquo;s been marked as deleted.
So if you have an API key, you may have your accounts full access after it&rsquo;s supposedly been deleted.</p><p>And the fix for it was super easy!~</p><p>We use a custom endpoint decorator, like flasks own @app.route, but we control what happens.
It&rsquo;s here the authentication is implemented, on all requests that go to routes defined with this decorator will run the Access Control controller.
Access Control goes through the auth options in its dunder init function and sets self.current_user to some admin user from the database.
To fix the problem I could&rsquo;ve made this check specific to the API keys by putting it in the API key controller that also has a user getter function.
But I chose to add an if statement to the Access Control user getter, this is called by our endpoint decorator.
So I literally just changed this.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>AccessControl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>current_user</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>get_current_user</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_user</span>
</span></span></code></pre></td></tr></table></div></div><p>To that!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>AccessControl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>current_user</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>get_current_user</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_user</span><span class=o>.</span><span class=n>deleted</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_user</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>raise</span> <span class=n>Forbidden</span>
</span></span></code></pre></td></tr></table></div></div><p>To fix this issue.</p><p>If you wonder why we &ldquo;raise Forbidden&rdquo;.
It has to do with the endpoint decorator which will catch all errors.
And will report them to us by e-mail and a slack bot.
The HTTP response will be error 500 if it&rsquo;s a Python error.
But if it&rsquo;s one of our own error classes that&rsquo;s been raised.
Then an error code, description and status code will be taken from that exception class and sent as the response.</p><p>There is also the case of the JWT secret key that&rsquo;s wayyy too small.
And not changed since it was introduced in the admin API.
Old keys is a theme on SkyLabs servers.</p><p>I&rsquo;m surprised no one, as far as we know anyway, has broken into the servers yet.</p><h3 id=funny>Funny</h3><p>Something I find kinda funny is the fact that those exception descriptions are in English, but the admin frontend is entirely in Norwegian only.
It&rsquo;s even got a big ass JavaScript file that maps all the error codes to messages.
And the best part about that whole situation is the fact that my boss/the sales guy at the company wants to sell our services outside Norway&mldr;
The only part that supports multiple languages is the actual captive portal, but even that has a bug which makes it so that only two languages can be active at one time.</p><h3 id=minor>Minor</h3><p>One minor issue I found in our production system is the password for the &ldquo;system&rdquo; account.
The password for that account is a real shitty one that I&rsquo;ve seen used several palaces at the company.
It&rsquo;s even been used as a Wi-Fi password.
To fix this one very easily I just enabled 2FA on the account.
But the whole account should probably just be deleted as nobody ever uses it.</p></article></div></div></main></div><footer><center><div class=footer-content><p>2020 - 2022 &copy; Sivert V. SÃ¦ther</p></div></center></footer></body></html>